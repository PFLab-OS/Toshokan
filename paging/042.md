paging/042: メモリリソースの管理
==========================

今回使用するディレクトリ：[sample/paging/042](https://github.com/PFLab-OS/Toshokan/tree/master/sample/paging/042)

アプリケーションがOSに対してメモリを追加で要求するようなケースは良くありますよね。お馴染みのmalloc()も、内部でOSに対してsbrkシステムコールを呼び、OSの手を借りてヒープ領域の拡張（拡張する領域への物理メモリの割り当て）を行っています。

今回はページングの話の延長線として、OSの中で起こる話を考えてみましょう。

アプリケーションのメモリ確保
---------------------------------
app1とapp2はそんなにメモリ領域を使っていないので、仮想メモリの0xC0000000からの4KBの領域で十分動作します。でも、もしもアプリケーションのサイズが大きくなり4KBになってしまったとして、それ以上メモリを使いたい時はどうすれば良いでしょうか？

ページテーブルの構造など、メモリを管理しているのはfriend.ccなので、appからfriend.ccに「メモリを使いたい」と要望を出すしかありません。もちろん、app1とapp2の中で勝手にメモリを割り当てる事も、今のコードならできなくは無いのですが、friend.ccがメモリの使い方を少し変えるとすぐに動かなくなってしまうので、あまりそれはやりたくありません。OSがアップデートされたらアプリケーションが動かなくなった、みたいな経験は皆さんもあるかもしれませんが、それと同じような話です。OSをアップデートしても、アプリケーションはこれまで通り動いて欲しいですからね。

今回、app1とapp2では仮想メモリ0xC0001000からのメモリ領域を使って計算をする事にします。app1では[entry1()内で0xC0001000からのメモリ領域にアクセス](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/app1.cc#L8-L11)し、app2では[entry4()内でアクセス](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/app2.cc#L14-L17)します。このため、app1はentry1()の最初でfriend.ccに対し、「0xC0001000に物理メモリを割り当ててくれ」と指示を出す必要があります。app2はentry4()の最初で同様の事をする必要があります。friend.ccはmap_page](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/friend.cc#L30-L34)という関数を用いてメモリ割り当てを行う事にします。

一般的にアプリケーションがOSに要求を出す際は「システムコール」と呼ばれる機能を用いるので、本当は今回もそのようにしたいのですが、システムコールを経由してappがfriend.ccを呼び出そうとすると結構複雑になってしまいます（システムコール自体の実装をしなければならないので）。そこで、だいぶ手抜きなのですが、「あたかもシステムコールを呼んだ」かのようにしたいと思います。

システムコールを呼ぶべき場所は、[entry1の先頭](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/app1.cc#L7)と[entry4の先頭](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/app2.cc#L13)になります。なので、[entry1を呼び出す直前](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/friend.cc#L81)と[entry4を呼び出す直前](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/friend.cc#L117)でmap_pageを呼ぶ事で、同等の事を実現します。

メモリをやりくりできるか？
---------------------------------
さて、friend.cc内の`map_page`関数について考えてみましょう。この関数は「物理メモリを仮想メモリに割り当てるための関数」であると先ほど書きましたが、実は表に出ていない重要な役割を持っています。「どの物理メモリを割り当てるか決定する」事です。要するにメモリ管理ですね。map_page関数はentry1の先頭とentry4の先頭の二箇所で呼ばれるわけですが、皆さんだったらどのようにメモリ割り当てを行うでしょうか？

一番簡単な方法は、それぞれ呼ばれた時に別々のメモリを割り当てる事です。例えば一回目に呼ばれた時は0x80700000からの4KBを割り当て、２回目に呼ばれた時は0x80701000からの4KBを割り当る、といった具合です。これなら、３回目がもしあっても、0x80702000からの4KBを割り当てれば良くなりますよね。

当然ですが、この方法は無限にメモリを必要とします。なので、一般的には「どのメモリが使われ、どのメモリが使われていないか」を管理し、使われなくなったメモリを再利用します。今回は、app1がentry1()終了後に0xC0001000からの仮想メモリを使わない事が分かっているので、map_pageが[毎回0x80700000からの4KBを割り当てる](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/friend.cc#L32)ようにしました。先程のやり方だと8KBのメモリがトータルで必要でしたが、この方法なら4KBで十分ですよね。ただし、この実装は皆さんもお気づきの通りとても危険な方法です。だってapp1やapp2が他の場所でもメモリを必要としたら、何時か破綻してしまいますからね。本当はきちんと[unmap_page](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/042/friend.cc#L36-L40)で、0x80700000からの4KBが使われていない事を記録し、0x80700000が誰にも使われていない時に限りmap_pageがメモリ割り当てをできるようにすべきでしょう。

是非皆さんも「自分だったらこんな風に賢くメモリを管理するんだ」と考えてみてください。実装までできると尚良いですね。

メモリ資源の効率的な活用
---------------------------------
皆さんは何時もPCのメモリが足りなくなった、みたいに思う事はありませんか？Webブラウザでタブを沢山開いたら、PCがどんどん遅くなっていってしまう、、、っていうアレです。恐らく殆どの方が体験した事があるでしょう。

メモリは無限ではありません。アプリケーションが沢山メモリを使おうとすれば、何時かメモリが枯渇します。だからできるだけメモリを効率的に使わなければいけません。それを実現するために生み出された仕組みがページングなのです。ページングのキモは「仮想メモリへの物理メモリの割り当てを4KBという単位で細かく制御できること」でした。今回、entry1()とentry4()で同じ4KBのメモリを割り当てる事が出来たのも、ページングが4KBづつメモリを管理しているからこそです。ページングを理解した皆さんにとっては「4KBのページを再利用する事なんて、当たり前だよ」って思っているかもしれません。でも仮想メモリと物理メモリの割り当てがこれほど柔軟ではなく、アプリケーションには1GBのメモリの塊が割り当てる事しかできなかったら、アプリケーションの間で4KBページを融通し、使うメモリ使用量を節約する、なんて芸当はとてもじゃないですができません。それぞれのアプリケーションが1GBづつメモリを占領して、それでおしまいです。

ページングを知っている今では当たり前の事でも、「なぜページングが生み出されたのか」「ページングが無ければどうなってしまうのか」を考えてみると、当たり前ではない事が意外と沢山出てきます。そういう所をきちんと意識すると、「ページングをより良く扱う事」ができそうですね。

メモリ管理とOS
---------------------------------
今回はページングを活用すればメモリを節約する事ができるのだ、という話をしました。しかしこれはあくまで「ページングを上手く活用すればメモリを節約する事ができる、でも活用しなければメモリは節約できない」という事です。ページングにはあくまでメモリの対応関係を設定するだけの機能しかありません。メモリの割り当てをどのようにするかというロジックを考えるのは、あくまでページング機構を制御するソフトウェアです。そのソフトウェアが賢ければメモリが節約できますし、頭が悪ければメモリを浪費する事になります。

メモリの管理を専門として行うプログラムこそがオペレーティングシステムです。オペレーティングシステムの使命は「リソースの管理と調停をし、限られたリソースをできる限り有効活用すること」と言われています。メモリはCPU実行時間やI/Oと並んで、コンピュータにおける重要なリソースの一つであり、メモリをいかに効率的に使い回せるかはオペレーティングシステムのメモリ管理アルゴリズムがいかに優秀かに依存しています。

メモリ管理というといろいろあります。malloc()やfree()だってメモリ管理のうちの一つですからね。しかし、オペレーティングシステムのメモリ管理が特殊なのは、「プロセスを越えて」コンピュータ「全体の」メモリを管理する事です。各々のプロセスがどのようにメモリを管理するかはプロセス自身が決めれば良い事ですが、それぞれのプロセスが好きなようにメモリを使ってしまうと、何時かメモリは足りなくなってしまうでしょう。オペレーティングシステムは全てのプロセスを統括する事ができる権限と責務を持っており、コンピュータを俯瞰する視点から現在の状況にとって最適な資源管理を行います。今回、２つのアプリに4KBづつ、合計8KB割り当てるのではなく、4KBの領域を融通する事によってメモリ消費量を節約するという手法を紹介しました。でもメモリがとても余っている状況であれば、4KBづつ割り当てても良いかもしれません。その方が融通のために必要な処理を削減できますからね。それはオペレーティングシステムのアルゴリズム次第です。

ページングを学ぶと、オペレーティングシステムの役目が何なのか、なぜオペレーティングシステムがコンピュータにとって必要なのか、何となくその雰囲気を感じられるような気がしませんか？

理解度テスト
---------------------------------

Q. 「メモリは無限ではありません」という文のメモリは仮想メモリを指すでしょうか？それとも物理メモリを指すでしょうか？
[gimmick:question({ answer: 1, list: ["仮想メモリ", "物理メモリ"]})]()

Q. コンピュータに搭載されているメモリ全体を管理し、有効活用する戦略を考えるのは誰でしょうか?
[gimmick:question({ answer: 2, list: ["CPU", "ブートファームウェア", "オペレーティングシステム", "アプリケーション"]})]()


[このセクションの目次に戻る](index.md)