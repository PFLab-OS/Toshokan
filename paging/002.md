paging/002: ２つのメモリ
==========================

今回使用するディレクトリ：[sample/paging/001](https://github.com/PFLab-OS/Toshokan/tree/master/sample/paging/002)

今回は[paging/001](paging/001.md)に[一行だけ書き加えたコード](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/002/friend.cc#L64)を使用します。リンク先を見てもらえれば分かる通り、hlt命令が挟まっていますね。これによってCPUをわざと途中で停止させています。

実際に途中で停止するか確認するために`make`してみましょう。どうですか？`hello!`とだけ出力されて止まりましたか？

なぜhlt命令を挟んだかというと、[paging/001](paging/001.md)の謎のソースコードが何をしているのか調べるためです。

QEMUのデバッグコンソールを使ってみましょう。

`hello!`と出力されているのを確認したら、別のシェルを開き、dockerコンテナの中に入ってください。

```bash
$ make attach_docker
```

次に、monitorスクリプトを用いてQEMUのデバッグコンソールに接続しましょう。

```
(コンテナ)~# ./monitor
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
QEMU 2.12.0 monitor - type 'help' for more information
(qemu)
```

CPUを切り替えた後、メモリをダンプします。

```
(qemu) cpu 1
(qemu) x /10x 0xC0000000
00000000c0000000: 0x90661eeb 0x4a70726b 0x00097000 0x00000000
00000000c0000010: 0x80000000 0x00000000 0x00000000 0x00000000
00000000c0000020: 0x8ec88cfa 0x168b66d8
```

２つ目のコマンドで、0xC0000000からの仮想メモリを表示しました。何で0xC0000000からなのかは、今は説明を保留させてください。（後のパートで説明します。）

では次に、こんなコマンドを叩いてみましょう。

```
(qemu) xp /10x 0x80000000
0000000080000000: 0x90661eeb 0x4a70726b 0x00097000 0x00000000
0000000080000010: 0x80000000 0x00000000 0x00000000 0x00000000
0000000080000020: 0x8ec88cfa 0x168b66d8
```

おっと、似たような出力が得られましたね。このコマンドは0x80000000からの「物理」メモリを表示しています。先程表示したメモリは「仮想」メモリでした。

仮想メモリと物理メモリという２つのメモリがあるらしい、そしてアドレスは違うけど、書き込まれている内容は何だか同じような気がする・・・。なぜ二種類のメモリがあるのでしょうか？0xC0000000からのメモリと、0x80000000からのメモリは果たして一緒なのでしょうか？このセクションではその辺を明らかにしていきましょう。

[このセクションの目次に戻る](index.md)
