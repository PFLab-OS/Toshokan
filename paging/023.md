paging/023: 同じメモリ領域でマルチタスク
==========================

今回使用するディレクトリ：[sample/paging/023](https://github.com/PFLab-OS/Toshokan/tree/master/sample/paging/023)

とりあえず実行してみよう！
------------------------------

細かい説明をいろいろする前に、まずはコードを実行してみましょう。今回はapp1.ccやapp2.ccを変更していないので、実行結果は[paging/022](022.md)と同じ出力になるはずですが、どうでしょうか・・・？

同じメモリ領域でマルチタスク
------------------------------
一つ大きく変わったのは、プログラムがロードされるアドレスがapp1もapp2も0x400000になった事です。実際、app1もapp2も同じリンカスクリプトapp.ldを参照しており、かつ[app1.ld](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/app.ld#L4)でも[app2.ld](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/app2.ld#L4)でも0x400000が指定されています。

あれれ、そういえば前回は「app2がapp1を上書きしないようにするために別のメモリ領域に置かないといけない」とありましたね。今頃皆さんは「何だ！同じメモリ領域でも良いんじゃん！」とお怒りの事でしょう。

でもちょっと待ってください。実は今回、同じメモリ領域でプログラムを動かせるようになった代わりに、複雑な処理をしなければいけなくなったのです・・・。

何で同じ領域でマルチタスク？
------------------------------
同じメモリ領域でプログラムを動かせるようにするための苦労話をする前に、「そもそも同じメモリ領域でマルチタスクをする必要があるのか？」について考えてみましょう。もし必要ないなら、[paging/022](022.md)の時のように別々のメモリ領域でマルチタスクすれば良いだけですからね。

[paging/022](022.md)ではapp1に0x400000からのメモリ領域を、app2に0x500000からのメモリ領域を割り当てました。では、もし別の誰かが作ったapp3を動かすとしたらどうなるでしょう？app3の作者はリンク時にどのアドレスを設定すれば良いでしょうか？0x400000や0x500000だとapp1と被ってしまいますから0x600000でしょうか？じゃあapp4の場合は？app3とapp4の作者が違ったら、どうやってメモリを衝突しないように調停すれば良いのでしょう？

皆さんも自分のPC上でインターネットからダウンロードしたプログラムを動かす事が多いですよね？プログラム間でメモリの割当アドレスが衝突して実行できない、なんて事があったら大変です。それならいっその事アドレスは固定してしまって、「同じメモリ領域にアクセスしているんだけど、なんか裏で良しなに処理されて実際には衝突していない」という方が良いと思いませんか？

これはサードパーティのアプリケーションを動かす必要のあるOS（その代表格が汎用OS）において良くある話です。一方「一つの会社がOSからアプリケーションまで全て作る」というような場合だと、アプリケーション毎に固定のメモリアドレスを割り振れば十分なので、わざわざ「同じメモリ領域で複数のプログラムを動かす」なんて事はしない場合もあります。組込みの世界とかだと良くありそうですよね。

頑張って裏で良しなに処理する
------------------------------
さて、app1とapp2を同じメモリ領域に置いても良いかなという気持ちに皆さんがなってきた所で、これをどう実現するか考えてみましょうか。といっても、実は考える程の事はなくて、ただメモリをコピーするだけです。

コンテキストというのはプログラムの状態です。メモリ領域もまたプログラムの状態の一部ですから、コンテキストを退避する際にメモリ領域も一度どこかにコピーし、コンテキストを復帰する際にロールバックすれば良いだけです。

まず、app1を[0x400000以外の所に読み込み](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/friend.cc#L19-L20)ます。そしてapp1の最初の実行時に[0x400000にロード](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/friend.cc#L26)します。コンテキストを退避する時は[元の場所にメモリコピー](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/friend.cc#L28)します。コンテキスト復帰時は[再度0x400000にロード](https://github.com/PFLab-OS/Toshokan/blob/master/sample/paging/023/friend.cc#L52)します。app2も同じような処理を行う事とします。

このようにすればapp1もapp2も0x400000からのメモリ領域に配置する事を前提としてリンクできるわけです。これが実際にきちんと動作する事は、皆さんが最初に確かめた通りですね！

なんか・・・重いぞ？
------------------------------
さて、これで汎用的にアプリケーションを動かせるぞ、と一安心したい所ですが・・・なんか嫌な予感がしませんか？

先程の手法はプログラムサイズ（一般的にはこれにデータ領域等も含まれる）分のデータをコンテキストの退避、復帰時にコピーするという物でした。今回は数百byteという小さなプログラムなのでコピーすべきメモリは微々たる物でしたが、もしもコピーしなければならない領域が増えていったら・・・？何だかどんどんスピードが遅くなっていきそうですよね・・・。

やはりこの手法は問題がありそうです。というわけで次回、ようやくページングの話に戻ってきますよ！

[このセクションの目次に戻る](index.md)
