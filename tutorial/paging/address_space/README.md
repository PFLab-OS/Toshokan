
# 仮想メモリと物理メモリ

## サンプル
本リポジトリをクローンし、このREADME.mdがあるディレクトリ上で`make`する事で、サンプルプログラムを実行できます。

ひとまず、`make`を実行してみましょう。

```
$ make
Silent mode is enabled by default. You can turn it off with 'make V=1'.
>>> build friend binary
　　（中略）
>>> send the binary to remote
>>> run hakase.bin on remote
0x80000000: 10102464c457f
ready
```

上記のような出力が得られ、readyが表示されたらOKです。以下の操作は、readyを表示させたまま別のターミナル上で行ってください。

## プログラムからのメモリアクセス
friend.ccのコードを見てみましょう。一部を抜き出すと以下のようになります。

```cc
// friend
  static const virt_addr_t vaddr = 0x80000000;
  uint64_t x = *((uint64_t *)vaddr);

  OFFLOAD({
    EXPORTED_SYMBOL(printf)("0x%lx: %lx\n", vaddr, x);
  });
```

friend上でアドレス0x80000000の64bitデータにアクセスし、printfで表示しています。

### MEMO

ちなみに0x80000000への64bitアクセスはOFFLOADセクションの外で行ってください。OFFLOADセクションの中で行うと、「hakaseにおけるアドレス0x80000000への64bitデータ」にアクセスしてしまいます。

## QEMUモニタ上での仮想メモリの確認

QEMU上からメモリを確認してみましょう。`make monitor`を実行した後、QEMUモニタで`x /2x 0x80000000`としてください。

```
$ make monitor
Silent mode is enabled by default. You can turn it off with 'make V=1'.
>>> connecting to QEMU monitor
????????QEMU 2.12.0 monitor - type 'help' for more information
(qemu) x /2x 0x80000000
x /2x 0x80000000
0000000080000000: 0x464c457f 0x00010102
```

エンディアンの都合で4byte単位でひっくり返ってますが、printfの表示結果と同じである事が分かります。

## 仮想メモリと物理メモリ
先程単に「QEMU上でメモリを確認してみよう」と書きましたが、上で確認したメモリは正確には「仮仮想メモリという物です。仮想メモリは、プログラムがアクセスする際に使用するメモリです。

仮想メモリの他に「物理メモリ」というメモリもあります。これはPCの基板上に実際に刺さっているメモリです。

## QEMUモニタ上での物理メモリの確認
QEMU上では、これとは物理メモリ内のデータも確認できるので、確認してみましょう。


物理メモリのアドレス（物理アドレス）0x80000000を確認してみます。

```
(qemu) xp /2x 0x80000000
xp /2x 0x80000000
0000000080000000: 0x00000000 0x00000000
```

しかしこれは先程のデータとは一致していません。

実は、先程のデータと一致するデータは、物理メモリ上では0x40000000に存在します。

```
(qemu) xp /2x 0x40000000
xp /2x 0x40000000
0000000040000000: 0x464c457f 0x00010102
```

これが何を示唆するかというと、「仮想メモリと物理メモリが一致するわけではない」という事です。不思議なように思えるでしょうが、とりあえず「そういうものだ」と理解してください。

## からくり

x86ページングが有効な環境における、仮想メモリと物理メモリの関係性を非常に単純に（いろいろ端折って）説明すると、仮想メモリの各々の4KBブロックは、物理メモリのどこかの4KBブロックに対応しています。

CPUには「仮想メモリのとある4KBが、物理メモリの中のどこの4KBに対応するか」の対応表を設定できます。この対応表を「ページテーブル」と呼びます。

friend.cc上で、仮想メモリ0x80000000からの4KBと物理メモリ0x40000000からの4KBを対応付けるコードが以下の通りです。コード内で、vaddrと0x40000000が参照されていますね。

```cc
// friend
  pd.entry[(vaddr % k1GB) / k2MB] =
      0x40000000 | (1 << 0) | (1 << 1) | (1 << 2) | (1 << 7);
```

このコードでページテーブルの設定をしているわけです。（厳密には、他にもいろいろすべき事があるのですが、それは追って説明します）


## 今回のまとめ
- プログラムが参照するメモリは仮想メモリ
- PCの基板上に実際に存在するメモリは物理メモリ
- 仮想メモリと物理メモリの対応表がページテーブル

## 補足
`make`を実行したターミナル（readyと表示されたまま停止しているターミナル）は、Ctrl+Cで終了する事ができます。